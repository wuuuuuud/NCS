// Generated by CoffeeScript 1.6.3
var activeForm, addClassEntryRoutine, classSequence, editInitialize, formInitialize, generateNavigator, listInfo, listInitialize, logging, loginRoutine, logs, pageInitialize, registerRoutine, switchFormTo, userInitialize,
  _this = this;

logs = '';

activeForm = null;

listInfo = {};

classSequence = ['root', 'book', 'series', 'volume', 'part', 'chapter', 'node', 'paragraph'];

generateNavigator = function() {};

loginRoutine = function() {};

pageInitialize = function() {
  logging('pageInitialize\r\n');
  if ($('#listWrapper').length > 0) {
    listInitialize($.parseJSON(data.innerHTML));
    $("#listWrapper").delegate(".name", "click", function(event) {
      var ajaxRequest;
      if (listInfo.className === "chapter") {
        return window.open('/paragraph/?parentKey=' + this.parentNode.id);
      }
      return ajaxRequest = $.ajax({
        "url": "/get/class",
        "method": "POST",
        "data": "key=" + this.parentNode.id
      }).done(function(returnData) {
        listInitialize($.parseJSON(returnData));
        return data.innerHTML = returnData;
      }).fail(function() {
        return alert("failed");
      });
    });
    return $("#classReturnButton").bind("click", function(event) {
      var ajaxRequest, listData;
      listData = $.parseJSON(data.innerHTML);
      return ajaxRequest = $.ajax({
        "url": "/get/class",
        "method": "POST",
        "data": "key=" + (listData.className === "book" ? "" : listData.self.parentKey)
      }).done(function(returnData) {
        listInitialize($.parseJSON(returnData));
        return data.innerHTML = returnData;
      }).fail(function() {
        return alert("failed");
      });
    });
  }
};

listInitialize = function(listData) {
  var div, value, _i, _len, _ref;
  listInfo = listData;
  logging('listInitialize\r\n');
  $('#listWrapper > .class-entry').remove();
  _ref = listData.data;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    value = _ref[_i];
    div = $("#listEntryPrototype").clone(true);
    div.css("display", "block");
    div.css("visibility", "visible");
    div[0].id = value.key;
    div[0].innerHTML = '<span class="name">' + value.name + '</span>';
    div.appendTo($("#listWrapper")[0]);
  }
  if (listData.self != null) {
    $(classReturnButton).css("visibility", "visible");
  } else {
    $(classReturnButton).css("visibility", "hidden");
  }
  addClassEntryForm.className.value = classSequence[classSequence.indexOf(listInfo.className) + 1];
  addClassEntryForm.parentKey.value = listData.self != null ? listData.self.key : '';
  return navigateBar.innerHTML = listInfo.className;
};

userInitialize = function() {
  $(loginText).bind("click", function() {
    $(fullScreenWrapper).css("visibility", "visible");
    return switchFormTo(loginForm);
  });
  $(registerText).bind("click", function() {
    $(fullScreenWrapper).css("visibility", "visible");
    return switchFormTo(registerForm);
  });
  return $(logoutText).bind("click", function() {
    return $.ajax({
      "url": "/logout/user",
      "method": "GET",
      "data": ""
    }).done(function(returnData) {
      var userInfo;
      userInfo = $.parseJSON(returnData);
      if (userInfo.success) {
        $(loggedText).css("display", "none");
        return $(notLoggedText).css("display", "inline");
      }
    }).fail(function() {
      return alert("failed");
    });
  });
};

switchFormTo = function(formId) {
  $("#submitForm form").css("display", "none");
  $(formId).css("display", "block");
  return activeForm = formId;
};

formInitialize = function() {
  return $(submitButton).bind("click", function() {
    if (activeForm === loginForm) {
      return loginRoutine();
    } else if (activeForm === registerForm) {
      return registerRoutine();
    } else if (activeForm === addClassEntryForm) {
      return addClassEntryRoutine();
    }
  });
};

loginRoutine = function() {
  return $.ajax({
    "url": "/login/user/",
    "method": "POST",
    "data": $(loginForm).serialize()
  }).done(function(returnData) {
    var userInfo;
    userInfo = $.parseJSON(returnData);
    if (userInfo.success) {
      $(loggedText).css("display", "inline");
      $(notLoggedText).css("display", "none");
      userNameText.innerHTML = userInfo.username;
      return $(fullScreenWrapper).css("visibility", "hidden");
    } else {
      return alert("大概哪里出错了...");
    }
  }).fail(function() {
    return alert("failed");
  });
};

registerRoutine = function() {
  if (registerForm.password.value !== registerForm.passwordCheck.value) {
    return alert("呃,两次密码输入不同。");
  }
  return $.ajax({
    "url": "/register/user/",
    "method": "POST",
    "data": $(registerForm).serialize()
  }).done(function(returnData) {
    var userInfo;
    userInfo = $.parseJSON(returnData);
    if (userInfo.success) {
      $(loggedText).css("display", "inline");
      $(notLoggedText).css("display", "none");
      userNameText.innerHTML = userInfo.username;
      return $(fullScreenWrapper).css("visibility", "hidden");
    } else {
      return alert("大概哪里出错了...");
    }
  }).fail(function() {
    return alert("failed");
  });
};

editInitialize = function() {
  return $(classEntryAddButton).bind("click", function() {
    $(fullScreenWrapper).css("visibility", "visible");
    return switchFormTo(addClassEntryForm);
  });
};

addClassEntryRoutine = function() {
  return $.ajax({
    "url": "/add/class/",
    "method": "POST",
    "data": $(addClassEntryForm).serialize()
  }).done(function(returnData) {
    var classInfo;
    classInfo = $.parseJSON(returnData);
    if (classInfo.success) {
      listInfo.data.push(classInfo.self);
      listInitialize(listInfo);
      return $(fullScreenWrapper).css("visibility", "hidden");
    } else {
      return alert("大概哪里出错了...");
    }
  }).fail(function() {
    return alert("failed");
  });
};

logging = function(text) {
  return logs += text;
};

$(function() {
  pageInitialize();
  userInitialize();
  editInitialize();
  return formInitialize();
});

/*
//@ sourceMappingURL=[CS]page.map
*/
